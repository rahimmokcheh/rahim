<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Ajouter Une Zone</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="icon" type="image/png" href="static/img/icon/logo_S4G.png">
    <!--------------- Google Web Fonts --------------->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600;700&family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">  
    <!--------------- Icon Font Stylesheet ------------>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-------------- Libraries Stylesheet ------------>
    <link href="/static/lib/animate/animate.min.css" rel="stylesheet">
    <link href="/static/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="/static/lib/lightbox/css/lightbox.min.css" rel="stylesheet">
    <!------------- Customized Bootstrap Stylesheet ------------>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!------------- Template Stylesheet ------------>
    <link href="/static/css/style.css" rel="stylesheet">
<!-----------------------background-------------------->
    <style>
        body {
            background-image: url('/static/img/forestbackground2.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin: 0; /* Remove default body margin */
            padding: 0; /* Remove default body padding */
        }
    
        /* Add this style to make the page fill the viewport */
        html, body {
            height: 100%;
        }
    
        /* Ensure your content container fills the viewport */
        .content-container {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
    </style>
<!-----------------------End background-------------------->

<!-- Importation des fichiers CSS et JS de Leaflet, une bibliothèque pour les cartes interactives -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
        
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""
    ></script>

    <!-- Importation des fichiers CSS et JS de Leaflet Draw, une extension pour dessiner sur les cartes Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

</head>
<body>
<!------------------------------ Spinner Start ------------------>
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
     </div>
<!------------------------------- Spinner End ------------------------>

<!-------------------------------Topbar Start ------------------------>
<div class="container-fluid bg-dark text-light px-0 py-2">
     <div class="row gx-0 d-none d-lg-flex">
         <div class="col-lg-7 px-5 text-start">
              <div class="h-100 d-inline-flex align-items-center me-4">
                    <span class="fa fa-phone-alt me-2"></span>
                    <span>+216 93 26 75 45</span>
              </div>
              <div class="h-100 d-inline-flex align-items-center">
                    <span class="far fa-envelope me-2"></span>
                    <span>contact@smartforgreen.com</span>
              </div>
           </div>
         <div class="col-lg-5 px-5 text-end">
             <div class="h-100 d-inline-flex align-items-center mx-n2">
                    <span>Suivez-Nous:</span>
                    <a class="btn btn-link text-light" href="https://www.facebook.com/SmartForGreen"><i class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-link text-light" href="https://www.linkedin.com/company/smart4green/"><i class="fab fa-linkedin-in"></i></a>
              </div>
         </div>
      </div>
  </div>
<!-------------------------------- Topbar End -------------------------->
 

<!-- Page Header Start -->
<div class="container-fluid page-header py-1 mb-1 wow fadeIn" data-wow-delay="0.1s">
    <div class="container text-center py-2">
        <h1 class="display-3 text-white mb-4 animated slideInDown">Bienvenue {{ appel_pseudo_superviseur }} !</h1>
        <nav aria-label="breadcrumb animated slideInDown">
            <ol class="breadcrumb justify-content-center mb-0">
                <li class="breadcrumb-item"><a href="#">Dessinez votre zone de survaillance ici !</a></li>
            </ol>
        </nav>
    </div>
</div>
<!-- Page Header End -->
<!----------------------------Etape d'avancement--------------------------------------->
<style>
    .pagination {
        margin-top: 25px;
        size-adjust: 15px;
        font-size: 1.2rem;
    }
</style>

<nav aria-label="...">
    <ul class="pagination justify-content-center text-center">
        <li class="page-item"><a class="page-link" >1</a></li>
        <li class="page-item"><a class="page-link" >2</a></li>
        <li class="page-item active" aria-current="page">
            <span class="page-link">Etape 3</span>
        </li>
        <li class="page-item"><a class="page-link" >4</a></li>
    </ul>
</nav>

<!------------------------------End Etape d'avancement----------------------------------->
<!--------------Message de succes---------->
<style>
    .custom-alert {
        width: 25rem; /* 1rem is approximately equal to the font size of the root element */
        margin: 0 auto; /* Center the alert box horizontally */
    }
</style>


{% if messages %}
<div class="alert alert-success alert-dismissible fade show text-center custom-alert" role="alert">
    {% for message in messages %}
        {{ message }}
    {% endfor %}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
<!--------------Message de succes---------->


<!--------------------------- Form Start --------------------------->
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="container-fluid pt-3 px-5">
        <div class="row justify-content-center">
            <div class="col-md-4 mb-4">
                <div class="bg-light rounded p-4">
                    <h6 class="mb-1.25 justify-content-center">Nom de Projet</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control rounded" value="{{votre_projet}}"readonly>
                    </div>

                    <h6 class="mb-1.25 justify-content-center">Nom de zone</h6>
                    <div class="input-group mb-3">
                    <input type="text" id ="name_zone" class="form-control" placeholder="Nom de zone" name="name_zone" aria-label="Coordonnées Des Zones" aria-describedby="basic-addon1">    

                    </div>

                    <!--------------------des fields pour retenir les coordonnées de polygone---------------------->
                    <input  type="text" id ="coords_polys" class="form-control" name="coords_polys" hidden>    
                    <!--------------------des fields pour retenir les coordonnées de polygone ---------------------->

                    <h6 class="mb-1.25 justify-content-center">Description</h6>
                    <div class="form-floating">
                        <textarea class="form-control" placeholder="Description" id="description" name="description" style="height: 150px;"></textarea>
                        <label for="description">Description</label>
                    </div>
                    <div class="input-group d-flex justify-content-center" >
                    <button class="btn btn-primary m-2 mx-2" type="submit" value="false" name="ajoutez_un_polygone">Ajoutez une autre Zone</button>
                    <button class="btn btn-primary m-2 mx-2" type="submit">Suivant !</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="bg-light rounded p-4">
                    <div id="map" style="height: 392px">
                        <div class="leaflet-control"></div>
                    </div>       
                </div>
            </div>
        </div>
    </div>
</form>
<!------------------------------------ Form End -------------------------------->

<!------------------------------- Copyright Start -->
<div class="container-fluid copyright py-4">
    <div class="container">
        <div class="row">
            <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                &copy; <a class="border-bottom" href="Home">Smart For Green</a>, Tous Droits Réservés.
            </div>

        </div>
    </div>
</div>
<!-------------------------------------- Copyright End -->

<!--------------------- Back to Top Fleshe -->
<a href="#" class="btn btn-lg btn-primary btn-lg-square rounded-circle back-to-top"><i class="bi bi-arrow-up"></i></a>
<!-------------------- Back to Top Fleshe -->

<!------------------------------------------- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/lib/wow/wow.min.js"></script>
<script src="/static/lib/easing/easing.min.js"></script>
<script src="/static/lib/waypoints/waypoints.min.js"></script>
<script src="/static/lib/owlcarousel/owl.carousel.min.js"></script>
<script src="/static/lib/counterup/counterup.min.js"></script>
<script src="/static/lib/parallax/parallax.min.js"></script>
<script src="/static/lib/isotope/isotope.pkgd.min.js"></script>
<script src="/static/lib/lightbox/js/lightbox.min.js"></script>
<!------------------------------------------- JavaScript Libraries -->
<!------------------------------------------ Template Javascript -->
<script src="/static/js/main.js"></script>
<!------------------------------------------ Template Javascript -->

<!----------------------Script Map Leaflet (polygone)----------------->
    <!----------------------Script Map Leaflet (recherche)----------------->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    var map = L.map("map").setView([36.89186227222111, 10.187473488849253], 16.5);

    L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        attribution: "Leaflet Map ©",
    }).addTo(map);

    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Rechercher des localisations",
        errorMessage: "Non Trouvé"
    }).on('markgeocode', function (e) {
        var bbox = e.geocode.bbox;
        var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
        ]);
        map.fitBounds(poly.getBounds(), {
            maxZoom: 16
        });
    }).addTo(map);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        draw: {
            polygon: {
                shapeOptions: {
                    color: "green",
                },
            },
            polyline: false,
            rectangle: false,
            circle: false,
            marker: false,
            circlemarker: false,
        },
        edit: {
            featureGroup: drawnItems,
            remove: true,
        },
    });

    map.addControl(drawControl);

    function updatePolygonCoordinates(layer) {
        var myjson = layer.toGeoJSON();
        let coords = myjson.features[0].geometry.coordinates;
        const multiPolygon = {
            type: "MultiPolygon",
            coordinates: [coords],
        };
        document.getElementById("coords_polys").value = JSON.stringify(multiPolygon);
    }

    map.on("draw:created", function (e) {
        var type = e.layerType, layer = e.layer;
        if (type === "polygon") {
            // Verify if there is already a polygon
            if(drawnItems.getLayers().length === 0) { // Check if the drawnItems group is empty
                drawnItems.addLayer(layer);
                updatePolygonCoordinates(drawnItems); // Update polygon coordinates
            } else {
                alert("Seul un polygone à la fois peut être dessiné !");
            }
        }
    });

    map.on("draw:edited", function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            if (layer instanceof L.Polygon) {
                updatePolygonCoordinates(drawnItems); // Update polygon coordinates upon edit
            }
        });
    });

    map.on("draw:deleted", function(e) {
        var layers = e.layers;
        layers.eachLayer(function(layer) {
            if (layer instanceof L.Polygon) {
                document.getElementById("coords_polys").value = "";
                document.getElementById("name_zone").value = "";
                document.getElementById("description").value = "";
            }
        });
    });

    // Ajout des zones existantes sur la carte
    // Remplacez ceci par votre code de chargement des zones
    {% for zone in zones %}
    var geojson_str = "{{ zone.coords_polys.json|escapejs }}";
    var geojson = JSON.parse(geojson_str);
    var polygonLayer = L.geoJSON(geojson).addTo(map);
    
    var tooltipContent = "<b>{{ zone.name_zone }}</b><br>{{ zone.description_zone }}";
    polygonLayer.bindTooltip(tooltipContent, { permanent: true, direction: 'center' }).openTooltip();

    {% endfor %}
</script>

<!---------------------End Script Map Leaflet (polygone)----------------->

</body>
</html>